{"version":3,"sources":["../../../../assets/Script/assets/Script/Network.js"],"names":["WebSocket","window","MozWebSocket","XNetEvent","CONNECT","CONNECT_ERROR","CONNECT_TIMEOUT","CONNECTED","CLOSE","XNet","cc","Class","extends","Component","statics","_socket","ws_host","_netPros","Map","_netEars","Array","_connectTimeout","_wsReConnectTimes","_reConnectFlag","_reConnectMax","dispatchXNet","event","msg","forEach","item","index","array","netEvent","listeners","slice","i","length","callback","target","Host","uri","Open","console","log","onopen","_onOpen","bind","onerror","_onError","onclose","_onClose","onmessage","_onMessage","cmd","rc","Close","close","readyState","error","data","JSON","parse","ListenerAdd","listenerList","push","ListenerRemove","splice","EarAdd","ear","EarRemove","pos","indexOf","ConnectCheck","flagReconn","CONNECTING","CLOSED","Send","text","OPEN","send"],"mappings":"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","file":"Network.js","sourceRoot":"../../../../assets/Script","sourcesContent":["var WebSocket = WebSocket || window.WebSocket || window.MozWebSocket;\n\n//import { XOpcodes } from \"./Opcodes\";\n\nvar XNetEvent = {\n  CONNECT: \"XC_NET_CONNECT\",\n  CONNECT_ERROR: \"XC_NET_CONNECT_ERROR\",\n  CONNECT_TIMEOUT: \"XC_NET_CONNECT_TIMEOUT\",\n  CONNECTED: \"XC_NET_CONNECTED\",\n  CLOSE: \"XC_NET_CLOSE\"\n};\n\n//个人采用文本方式来收发数据\n//频率高的采用二进制数据进行收发 例如 移动数据包\n\nvar XNet = cc.Class({\n  extends: cc.Component,\n  statics: {\n    _socket: null,\n    ws_host: \"ws://test.9966886699.com:8086/game\",\n    _netPros: new Map(),\n    _netEars: new Array(),\n    _connectTimeout: 5,\n    _wsReConnectTimes: 0,\n    _reConnectFlag: false,\n    _reConnectMax: 3,\n\n    dispatchXNet(event, msg) {\n      //        XGame.DoXEvent(event,msg);\n\n      this._netEars.forEach(function(item, index, array) {\n        item.netEvent(event, msg);\n      });\n\n      if (this._netPros[event]) {\n        var listeners = this._netPros[event].slice();\n        for (var i = 0; i < listeners.length; i++) {\n          listeners[i].callback(msg, listeners[i].target);\n        }\n      }\n    },\n\n    Host: function(uri) {\n      this.ws_host = uri;\n    },\n\n    Open: function() {\n      //console.log(\"ss:\" + this._socket.readyState);\n      if (this._socket == null) {\n        console.log(\"connect \" + this.ws_host);\n        //            if(this._socket!=null) delete this._socket;\n        this._socket = new WebSocket(this.ws_host);\n        this._socket.onopen = this._onOpen.bind(this);\n        this._socket.onerror = this._onError.bind(this);\n        this._socket.onclose = this._onClose.bind(this);\n        this._socket.onmessage = this._onMessage.bind(this);\n\n        //cc.director.getScheduler().schedule(this.connectTimeoutCheck,this,1, 5, 3,false);\n        this.dispatchXNet(XNetEvent.CONNECT, {\n          cmd: XNetEvent.CONNECT,\n          rc: 0\n        });\n      }\n      return this;\n    },\n\n    Close() {\n      if (this._socket != null) {\n        this._socket.close();\n        delete this._socket;\n        //        this._socket = nil;//这个不需要\n        //cc.director.getScheduler().\n        console.log(\"WebSocket is closed now.\");\n        XNet.dispatchXNet(XNetEvent.CLOSE, {\n          cmd: XNetEvent.CLOSE,\n          rc: 0\n        });\n      }\n    },\n\n    readyState() {\n      if (this._socket) return this._socket.readyState;\n      return -1;\n    },\n\n    _onOpen: function(event) {\n      console.log(\"connected \" + this.ws_host);\n      //utils.OutObj(evt);\n      //var event = new cc.Event(this,\"Network\",true);\n      //event.setUserData(\"{...}\");\n      //cc.eventTarget.dispatchEvent(event);\n      // cc.EventTarget.dispatchEvent(\"adas\",\"123\",evt);\n\n      //\n      //cc.eventManager.dispatchCustomEvent(\"XNetOpened\", {a:1,b:2});\n\n      //var event=new cc.EventCustom(\"XNetOpened\");\n      //cc.SystemEvent.dispatchCustomEvent(event);\n      this.dispatchXNet(XNetEvent.CONNECTED, {\n        cmd: XNetEvent.CONNECTED,\n        rc: 0\n      });\n    },\n\n    _onError: function(event) {\n      XNet.dispatchXNet(XNetEvent.CONNECT_ERROR, {\n        cmd: XNetEvent.CONNECT_ERROR,\n        rc: event\n      });\n      console.error(\"WebSocket error observed:\", event);\n    },\n\n    _onClose: function(event) {\n      console.log(\"WebSocket is closed now.\");\n      XNet.dispatchXNet(XNetEvent.CLOSE, {\n        cmd: XNetEvent.CLOSE,\n        rc: 0\n      });\n\n      // if (this._socket) {\n      //   delete this._socket;\n      //   this._socket = null;\n      // }\n    },\n\n    _onMessage: function(event) {\n      console.log(\"WebSocket message received:\" + event.data);\n      let msg = JSON.parse(event.data);\n      //console.log(msg.cmd);\n      XNet.dispatchXNet(msg.cmd, msg);\n    },\n\n    ListenerAdd(event, callback) {\n      if (!event || !callback) return;\n      var listenerList = this._netPros[event];\n      if (!listenerList) listenerList = this._netPros[event] = new Array();\n      for (var i = 0; i < listenerList.length; i++) {\n        if (listenerList[i] == callback) return;\n      }\n      listenerList.push(callback);\n    },\n\n    ListenerRemove(event, callback) {\n      if (!event || !callback) return;\n      var listenerList = this._netPros[event];\n      if (listenerList) {\n        for (var i = 0; i < listenerList.length; i++) {\n          if (listenerList[i] == callback) {\n            listenerList.splice(i, 1);\n            return;\n          }\n        }\n      }\n    },\n\n    EarAdd(ear) {\n      this._netEars.push(ear);\n    },\n\n    EarRemove(ear) {\n      let pos = this._netEars.indexOf(ear);\n      this._netEars.splice(pos, 1);\n    },\n\n    ConnectCheck: function(flagReconn) {\n      if (this._socket == null) return;\n\n      if (this._socket.readyState == WebSocket.CONNECTING) {\n        console.log(\"websocket connect timeout\");\n        XNet.dispatchXNet(XNetEvent.CONNECT_TIMEOUT, {\n          cmd: XNetEvent.CONNECT_TIMEOUT,\n          rc: 0\n        });\n        if (flagReconn) this.Open();\n      }\n\n      if (this._socket.readyState == WebSocket.CLOSED) {\n        console.log(\"websocket reconnect\");\n        //this.connect();\n      }\n    },\n\n    Send: function(text) {\n      if (!this._socket) return;\n      if (this._socket.readyState == WebSocket.OPEN) {\n        this._socket.send(text);\n      }\n    }\n  }\n});\n\nexport { XNet, XNetEvent };\n"]}