{"version":3,"sources":["..\\..\\..\\..\\assets\\Script/assets\\Script\\Network.js"],"names":["WebSocket","window","MozWebSocket","XNetEvent","CONNECT","CONNECT_ERROR","CONNECT_TIMEOUT","CONNECTED","CLOSE","XNet","cc","Class","extends","Component","statics","_socket","ws_host","_netPros","Map","_netEars","Array","_connectTimeout","_wsReConnectTimes","_reConnectFlag","_reConnectMax","dispatchXNet","event","msg","forEach","item","index","array","netEvent","listeners","slice","i","length","callback","target","Host","uri","Open","console","log","onopen","_onOpen","bind","onerror","_onError","onclose","_onClose","onmessage","_onMessage","cmd","rc","Close","close","readyState","error","data","JSON","parse","ListenerAdd","listenerList","push","ListenerRemove","splice","EarAdd","ear","EarRemove","pos","indexOf","ConnectCheck","flagReconn","CONNECTING","CLOSED","Send","text","OPEN","send"],"mappings":"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","file":"Network.js","sourceRoot":"..\\..\\..\\..\\assets\\Script","sourcesContent":["var WebSocket = WebSocket || window.WebSocket || window.MozWebSocket;\r\n\r\n//import { XOpcodes } from \"./Opcodes\";\r\n\r\n/*\r\nwebsocket 两种监听方式\r\n*/\r\n\r\nvar XNetEvent = {\r\n  CONNECT: \"XC_NET_CONNECT\",\r\n  CONNECT_ERROR: \"XC_NET_CONNECT_ERROR\",\r\n  CONNECT_TIMEOUT: \"XC_NET_CONNECT_TIMEOUT\",\r\n  CONNECTED: \"XC_NET_CONNECTED\",\r\n  CLOSE: \"XC_NET_CLOSE\"\r\n};\r\n\r\n//个人采用文本方式来收发数据\r\n//频率高的采用二进制数据进行收发 例如 移动数据包\r\n\r\nvar XNet = cc.Class({\r\n  extends: cc.Component,\r\n  statics: {\r\n    _socket: null,\r\n    ws_host: \"ws://test.9966886699.com:8086/game\",\r\n    _netPros: new Map(),\r\n    _netEars: new Array(),\r\n    _connectTimeout: 5,\r\n    _wsReConnectTimes: 0,\r\n    _reConnectFlag: false,\r\n    _reConnectMax: 3,\r\n\r\n    /**\r\n     * 发布收到事件消息\r\n     * event事件名\r\n     * msg 消息内容\r\n     */\r\n    dispatchXNet(event, msg) {\r\n      //        XGame.DoXEvent(event,msg);\r\n\r\n      this._netEars.forEach(function(item, index, array) {\r\n        item.netEvent(event, msg);\r\n      });\r\n\r\n      if (this._netPros[event]) {\r\n        var listeners = this._netPros[event].slice();\r\n        for (var i = 0; i < listeners.length; i++) {\r\n          listeners[i].callback(msg, listeners[i].target);\r\n        }\r\n      }\r\n    },\r\n\r\n    Host: function(uri) {\r\n      this.ws_host = uri;\r\n    },\r\n\r\n    Open: function() {\r\n      //console.log(\"ss:\" + this._socket.readyState);\r\n      if (this._socket == null) {\r\n        console.log(\"connect \" + this.ws_host);\r\n        //            if(this._socket!=null) delete this._socket;\r\n        this._socket = new WebSocket(this.ws_host);\r\n        this._socket.onopen = this._onOpen.bind(this);\r\n        this._socket.onerror = this._onError.bind(this);\r\n        this._socket.onclose = this._onClose.bind(this);\r\n        this._socket.onmessage = this._onMessage.bind(this);\r\n\r\n        //cc.director.getScheduler().schedule(this.connectTimeoutCheck,this,1, 5, 3,false);\r\n        this.dispatchXNet(XNetEvent.CONNECT, {\r\n          cmd: XNetEvent.CONNECT,\r\n          rc: 0\r\n        });\r\n      }\r\n      return this;\r\n    },\r\n\r\n    Close() {\r\n      if (this._socket != null) {\r\n        this._socket.close();\r\n        delete this._socket;\r\n        //        this._socket = nil;//这个不需要\r\n        //cc.director.getScheduler().\r\n        console.log(\"WebSocket is closed now.\");\r\n        XNet.dispatchXNet(XNetEvent.CLOSE, {\r\n          cmd: XNetEvent.CLOSE,\r\n          rc: 0\r\n        });\r\n      }\r\n    },\r\n\r\n    readyState() {\r\n      if (this._socket) return this._socket.readyState;\r\n      return -1;\r\n    },\r\n\r\n    _onOpen: function(event) {\r\n      console.log(\"connected \" + this.ws_host);\r\n      //utils.OutObj(evt);\r\n      //var event = new cc.Event(this,\"Network\",true);\r\n      //event.setUserData(\"{...}\");\r\n      //cc.eventTarget.dispatchEvent(event);\r\n      // cc.EventTarget.dispatchEvent(\"adas\",\"123\",evt);\r\n\r\n      //\r\n      //cc.eventManager.dispatchCustomEvent(\"XNetOpened\", {a:1,b:2});\r\n\r\n      //var event=new cc.EventCustom(\"XNetOpened\");\r\n      //cc.SystemEvent.dispatchCustomEvent(event);\r\n      this.dispatchXNet(XNetEvent.CONNECTED, {\r\n        cmd: XNetEvent.CONNECTED,\r\n        rc: 0\r\n      });\r\n    },\r\n\r\n    _onError: function(event) {\r\n      XNet.dispatchXNet(XNetEvent.CONNECT_ERROR, {\r\n        cmd: XNetEvent.CONNECT_ERROR,\r\n        rc: event\r\n      });\r\n      console.error(\"WebSocket error observed:\", event);\r\n    },\r\n\r\n    _onClose: function(event) {\r\n      console.log(\"WebSocket is closed now.\");\r\n      XNet.dispatchXNet(XNetEvent.CLOSE, {\r\n        cmd: XNetEvent.CLOSE,\r\n        rc: 0\r\n      });\r\n\r\n      // if (this._socket) {\r\n      //   delete this._socket;\r\n      //   this._socket = null;\r\n      // }\r\n    },\r\n\r\n    _onMessage: function(event) {\r\n      console.log(\"WebSocket message received:\" + event.data);\r\n      let msg = JSON.parse(event.data);\r\n      //console.log(msg.cmd);\r\n      XNet.dispatchXNet(msg.cmd, msg);\r\n    },\r\n\r\n    /**\r\n     * 添加监听\r\n     */\r\n    ListenerAdd(event, callback) {\r\n      if (!event || !callback) return;\r\n      var listenerList = this._netPros[event];\r\n      if (!listenerList) listenerList = this._netPros[event] = new Array();\r\n      for (var i = 0; i < listenerList.length; i++) {\r\n        if (listenerList[i] == callback) return;\r\n      }\r\n      listenerList.push(callback);\r\n    },\r\n\r\n    ListenerRemove(event, callback) {\r\n      if (!event || !callback) return;\r\n      var listenerList = this._netPros[event];\r\n      if (listenerList) {\r\n        for (var i = 0; i < listenerList.length; i++) {\r\n          if (listenerList[i] == callback) {\r\n            listenerList.splice(i, 1);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    EarAdd(ear) {\r\n      this._netEars.push(ear);\r\n    },\r\n\r\n    EarRemove(ear) {\r\n      let pos = this._netEars.indexOf(ear);\r\n      this._netEars.splice(pos, 1);\r\n    },\r\n\r\n    ConnectCheck: function(flagReconn) {\r\n      if (this._socket == null) return;\r\n\r\n      if (this._socket.readyState == WebSocket.CONNECTING) {\r\n        console.log(\"websocket connect timeout\");\r\n        XNet.dispatchXNet(XNetEvent.CONNECT_TIMEOUT, {\r\n          cmd: XNetEvent.CONNECT_TIMEOUT,\r\n          rc: 0\r\n        });\r\n        if (flagReconn) this.Open();\r\n      }\r\n\r\n      if (this._socket.readyState == WebSocket.CLOSED) {\r\n        console.log(\"websocket reconnect\");\r\n        //this.connect();\r\n      }\r\n    },\r\n\r\n    Send: function(text) {\r\n      if (!this._socket) return;\r\n      if (this._socket.readyState == WebSocket.OPEN) {\r\n        this._socket.send(text);\r\n      }\r\n    }\r\n  }\r\n});\r\n\r\nexport { XNet, XNetEvent };\r\n"]}